{"version":3,"file":"index-B73ZNVef.js","sources":["../../src/agents/built-in/scrape/bot-detection.ts","../../src/agents/built-in/scrape/html-parser.ts","../../src/agents/built-in/scrape/scrape-agent.ts"],"sourcesContent":["/**\n * Bot Protection Detection\n *\n * Detects common bot protection mechanisms like Cloudflare, Captcha, etc.\n */\n\nimport type { BotProtectionResult } from './types.js'\n\nconst BOT_PROTECTION_KEYWORDS = [\n  'cloudflare',\n  'just a moment',\n  'checking your browser',\n  'please wait',\n  'access denied',\n  'captcha',\n  'recaptcha',\n  'challenge',\n  'verify you are human',\n  'attention required',\n  'enable javascript',\n  'blocked',\n]\n\nconst MIN_CONTENT_LENGTH = 800\n\n/**\n * Detect if content contains bot protection\n */\nexport function detectBotProtection(content: string): BotProtectionResult {\n  const reasons: string[] = []\n  const lowercaseContent = content.toLowerCase()\n\n  // Check length\n  if (content.length < MIN_CONTENT_LENGTH) {\n    reasons.push(`Content too short (${content.length} < ${MIN_CONTENT_LENGTH})`)\n  }\n\n  // Check for bot protection keywords\n  for (const keyword of BOT_PROTECTION_KEYWORDS) {\n    if (lowercaseContent.includes(keyword)) {\n      reasons.push(`Contains bot protection keyword: \"${keyword}\"`)\n    }\n  }\n\n  return {\n    detected: reasons.length > 0,\n    reasons,\n  }\n}\n\n/**\n * Check if content is successful (no bot protection, sufficient length)\n */\nexport function isContentSuccessful(content: string): boolean {\n  const result = detectBotProtection(content)\n  return !result.detected\n}\n","/**\n * HTML Parser - Tier 3 Fallback\n *\n * Simple HTML parsing and text extraction when browser rendering fails.\n */\n\n/**\n * Extract text content from HTML\n */\nexport function extractTextFromHTML(html: string): string {\n  // Remove script and style tags\n  let text = html.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n  text = text.replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, '')\n\n  // Remove HTML tags\n  text = text.replace(/<[^>]+>/g, ' ')\n\n  // Decode HTML entities\n  text = text.replace(/&nbsp;/g, ' ')\n  text = text.replace(/&amp;/g, '&')\n  text = text.replace(/&lt;/g, '<')\n  text = text.replace(/&gt;/g, '>')\n  text = text.replace(/&quot;/g, '\"')\n  text = text.replace(/&#39;/g, \"'\")\n\n  // Clean up whitespace\n  text = text.replace(/\\s+/g, ' ')\n  text = text.trim()\n\n  return text\n}\n\n/**\n * Extract title from HTML\n */\nexport function extractTitleFromHTML(html: string): string {\n  const titleMatch = html.match(/<title[^>]*>([^<]+)<\\/title>/i)\n  if (titleMatch && titleMatch[1]) {\n    return titleMatch[1].trim()\n  }\n  return ''\n}\n\n/**\n * Convert HTML to simple markdown\n */\nexport function convertHTMLToMarkdown(html: string): string {\n  let markdown = html\n\n  // Extract title\n  const title = extractTitleFromHTML(html)\n\n  // Remove script and style tags\n  markdown = markdown.replace(/<script\\b[^<]*(?:(?!<\\/script>)<[^<]*)*<\\/script>/gi, '')\n  markdown = markdown.replace(/<style\\b[^<]*(?:(?!<\\/style>)<[^<]*)*<\\/style>/gi, '')\n\n  // Convert headings\n  markdown = markdown.replace(/<h1[^>]*>([^<]+)<\\/h1>/gi, '\\n# $1\\n')\n  markdown = markdown.replace(/<h2[^>]*>([^<]+)<\\/h2>/gi, '\\n## $1\\n')\n  markdown = markdown.replace(/<h3[^>]*>([^<]+)<\\/h3>/gi, '\\n### $1\\n')\n  markdown = markdown.replace(/<h4[^>]*>([^<]+)<\\/h4>/gi, '\\n#### $1\\n')\n  markdown = markdown.replace(/<h5[^>]*>([^<]+)<\\/h5>/gi, '\\n##### $1\\n')\n  markdown = markdown.replace(/<h6[^>]*>([^<]+)<\\/h6>/gi, '\\n###### $1\\n')\n\n  // Convert links\n  markdown = markdown.replace(/<a[^>]*href=\"([^\"]*)\"[^>]*>([^<]+)<\\/a>/gi, '[$2]($1)')\n\n  // Convert bold/strong\n  markdown = markdown.replace(/<(strong|b)[^>]*>([^<]+)<\\/(strong|b)>/gi, '**$2**')\n\n  // Convert italic/em\n  markdown = markdown.replace(/<(em|i)[^>]*>([^<]+)<\\/(em|i)>/gi, '*$2*')\n\n  // Convert lists\n  markdown = markdown.replace(/<li[^>]*>([^<]+)<\\/li>/gi, '- $1\\n')\n\n  // Convert paragraphs\n  markdown = markdown.replace(/<p[^>]*>([^<]+)<\\/p>/gi, '\\n$1\\n')\n\n  // Remove remaining HTML tags\n  markdown = markdown.replace(/<[^>]+>/g, '')\n\n  // Decode HTML entities\n  markdown = markdown.replace(/&nbsp;/g, ' ')\n  markdown = markdown.replace(/&amp;/g, '&')\n  markdown = markdown.replace(/&lt;/g, '<')\n  markdown = markdown.replace(/&gt;/g, '>')\n  markdown = markdown.replace(/&quot;/g, '\"')\n  markdown = markdown.replace(/&#39;/g, \"'\")\n\n  // Clean up whitespace\n  markdown = markdown.replace(/\\n{3,}/g, '\\n\\n')\n  markdown = markdown.replace(/[ \\t]+/g, ' ')\n  markdown = markdown.trim()\n\n  // Prepend title if found\n  if (title) {\n    markdown = `# ${title}\\n\\n${markdown}`\n  }\n\n  return markdown\n}\n","/**\n * Scrape Agent - 3-Tier Web Scraping\n *\n * Tier 1: CF Browser Rendering (domcontentloaded) - Fast, ~350ms\n * Tier 2: CF Browser Rendering (networkidle2) - JS wait, ~2s\n * Tier 3: HTML parsing fallback - ~1.5s\n *\n * Features:\n * - Automatic fallback on bot protection detection\n * - Multiple return formats (markdown, html, text)\n * - Configurable strategy (fast, balanced, aggressive)\n */\n\nimport { BaseAgent, type AgentExecutionContext } from '../../base-agent.js'\nimport type { AgentConfig } from '../../../runtime/parser.js'\nimport type { ScrapeConfig, ScrapeInput, ScrapeResult } from './types.js'\nimport { detectBotProtection, isContentSuccessful } from './bot-detection.js'\nimport { extractTextFromHTML, extractTitleFromHTML, convertHTMLToMarkdown } from './html-parser.js'\nimport { createLogger } from '../../../observability/index.js'\n\nconst logger = createLogger({ serviceName: 'scrape-agent' })\n\nexport class ScrapeMember extends BaseAgent {\n  private scrapeConfig: ScrapeConfig\n\n  constructor(\n    config: AgentConfig,\n    private readonly env: Env\n  ) {\n    super(config)\n\n    const cfg = config.config as ScrapeConfig | undefined\n\n    this.scrapeConfig = {\n      strategy: cfg?.strategy || 'balanced',\n      returnFormat: cfg?.returnFormat || 'markdown',\n      blockResources: cfg?.blockResources !== false,\n      userAgent: cfg?.userAgent,\n      timeout: cfg?.timeout || 30000,\n    }\n  }\n\n  protected async run(context: AgentExecutionContext): Promise<ScrapeResult> {\n    const input = context.input as ScrapeInput\n\n    if (!input.url) {\n      throw new Error('Scrape agent requires \"url\" in input')\n    }\n\n    const startTime = Date.now()\n    const strategy = this.scrapeConfig.strategy!\n\n    // Tier 1: Fast browser rendering (domcontentloaded)\n    try {\n      const result = await this.tier1Fast(input.url)\n      if (isContentSuccessful(result.html)) {\n        return this.formatResult(result, 1, Date.now() - startTime)\n      }\n    } catch (error) {\n      logger.debug('Tier 1 fast scrape failed, trying Tier 2', {\n        url: input.url,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      })\n    }\n\n    // If strategy is 'fast', return fallback\n    if (strategy === 'fast') {\n      return this.fallbackResult(input.url, Date.now() - startTime)\n    }\n\n    // Tier 2: Slow browser rendering (networkidle2)\n    try {\n      const result = await this.tier2Slow(input.url)\n      if (isContentSuccessful(result.html)) {\n        return this.formatResult(result, 2, Date.now() - startTime)\n      }\n    } catch (error) {\n      logger.debug('Tier 2 slow scrape failed, trying Tier 3', {\n        url: input.url,\n        error: error instanceof Error ? error.message : 'Unknown error',\n      })\n    }\n\n    // If strategy is 'balanced', return fallback\n    if (strategy === 'balanced') {\n      return this.fallbackResult(input.url, Date.now() - startTime)\n    }\n\n    // Tier 3: HTML parsing fallback\n    const result = await this.tier3HTMLParsing(input.url)\n    return this.formatResult(result, 3, Date.now() - startTime)\n  }\n\n  /**\n   * Tier 1: Fast browser rendering with domcontentloaded\n   */\n  private async tier1Fast(url: string): Promise<{ html: string; title: string }> {\n    // TODO: Integrate with Cloudflare Browser Rendering API\n    // For now, use standard fetch as placeholder\n    const response = await fetch(url, {\n      headers: {\n        'User-Agent': this.scrapeConfig.userAgent || 'Mozilla/5.0 (compatible; Conductor/1.0)',\n      },\n      signal: AbortSignal.timeout(this.scrapeConfig.timeout!),\n    })\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n    }\n\n    const html = await response.text()\n    const title = extractTitleFromHTML(html)\n\n    return { html, title }\n  }\n\n  /**\n   * Tier 2: Slow browser rendering with networkidle2\n   */\n  private async tier2Slow(url: string): Promise<{ html: string; title: string }> {\n    // TODO: Integrate with Cloudflare Browser Rendering API with networkidle2\n    // For now, fallback to tier1\n    return await this.tier1Fast(url)\n  }\n\n  /**\n   * Tier 3: HTML parsing fallback\n   */\n  private async tier3HTMLParsing(url: string): Promise<{ html: string; title: string }> {\n    const response = await fetch(url, {\n      headers: {\n        'User-Agent': this.scrapeConfig.userAgent || 'Mozilla/5.0 (compatible; Conductor/1.0)',\n      },\n      signal: AbortSignal.timeout(this.scrapeConfig.timeout!),\n    })\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n    }\n\n    const html = await response.text()\n    const title = extractTitleFromHTML(html)\n\n    return { html, title }\n  }\n\n  /**\n   * Format the result based on configured return format\n   */\n  private formatResult(\n    data: { html: string; title: string },\n    tier: 1 | 2 | 3,\n    duration: number\n  ): ScrapeResult {\n    const botProtection = detectBotProtection(data.html)\n    const format = this.scrapeConfig.returnFormat!\n\n    const result: ScrapeResult = {\n      url: '',\n      tier,\n      duration,\n      botProtectionDetected: botProtection.detected,\n      contentLength: data.html.length,\n      title: data.title,\n    }\n\n    // Add requested format\n    if (format === 'html' || format === 'markdown') {\n      result.html = data.html\n    }\n\n    if (format === 'markdown') {\n      result.markdown = convertHTMLToMarkdown(data.html)\n    }\n\n    if (format === 'text') {\n      result.text = extractTextFromHTML(data.html)\n    }\n\n    return result\n  }\n\n  /**\n   * Return a fallback result when all tiers fail\n   */\n  private fallbackResult(url: string, duration: number): ScrapeResult {\n    return {\n      url,\n      tier: 3,\n      duration,\n      botProtectionDetected: true,\n      contentLength: 0,\n      markdown: '',\n      html: '',\n      text: '',\n    }\n  }\n}\n"],"names":["result"],"mappings":"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"}