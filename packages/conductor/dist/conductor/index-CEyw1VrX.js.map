{"version":3,"file":"index-CEyw1VrX.js","sources":["../../src/agents/built-in/tools/mcp-client.ts","../../src/agents/built-in/tools/tools-agent.ts"],"sourcesContent":["/**\n * MCP Client - HTTP Transport\n *\n * Client for communicating with MCP servers over HTTP\n */\n\nimport type {\n  MCPServerConfig,\n  MCPToolListResponse,\n  MCPToolInvocationRequest,\n  MCPToolInvocationResponse,\n} from './types.js'\n\nexport class MCPClient {\n  constructor(private readonly config: MCPServerConfig) {}\n\n  /**\n   * Discover available tools from MCP server\n   */\n  async listTools(): Promise<MCPToolListResponse> {\n    const url = `${this.config.url}/tools`\n    const response = await this.request<MCPToolListResponse>(url, {\n      method: 'GET',\n    })\n    return response\n  }\n\n  /**\n   * Invoke a tool on the MCP server\n   */\n  async invokeTool(\n    toolName: string,\n    args: Record<string, unknown>\n  ): Promise<MCPToolInvocationResponse> {\n    const url = `${this.config.url}/tools/${encodeURIComponent(toolName)}`\n    const body: MCPToolInvocationRequest = {\n      name: toolName,\n      arguments: args,\n    }\n\n    const response = await this.request<MCPToolInvocationResponse>(url, {\n      method: 'POST',\n      body: JSON.stringify(body),\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    })\n\n    return response\n  }\n\n  /**\n   * Make an authenticated HTTP request to MCP server\n   */\n  private async request<T>(url: string, options: RequestInit): Promise<T> {\n    // Add authentication headers\n    const headers: Record<string, string> = {\n      ...(options.headers as Record<string, string>),\n    }\n\n    if (this.config.auth) {\n      if (this.config.auth.type === 'bearer' && this.config.auth.token) {\n        headers['Authorization'] = `Bearer ${this.config.auth.token}`\n      } else if (this.config.auth.type === 'oauth' && this.config.auth.accessToken) {\n        headers['Authorization'] = `Bearer ${this.config.auth.accessToken}`\n      }\n    }\n\n    // Set timeout\n    const timeout = this.config.timeout || 30000\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), timeout)\n\n    try {\n      const response = await fetch(url, {\n        ...options,\n        headers,\n        signal: controller.signal,\n      })\n\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => 'Unknown error')\n        throw new Error(\n          `MCP server error: ${response.status} ${response.statusText} - ${errorText}`\n        )\n      }\n\n      const data = await response.json()\n      return data as T\n    } catch (error) {\n      if (error instanceof Error) {\n        if (error.name === 'AbortError') {\n          throw new Error(`MCP request timeout after ${timeout}ms`)\n        }\n        throw error\n      }\n      throw new Error('Unknown MCP client error')\n    } finally {\n      clearTimeout(timeoutId)\n    }\n  }\n}\n","/**\n * Tools Agent - MCP Tool Invocation\n *\n * Invokes external MCP (Model Context Protocol) tools over HTTP.\n *\n * Features:\n * - HTTP-only transport (no stdio complexity)\n * - Tool discovery caching\n * - Bearer and OAuth authentication\n * - Configurable timeouts\n */\n\nimport { BaseAgent, type AgentExecutionContext } from '../../base-agent.js'\nimport type { AgentConfig } from '../../../runtime/parser.js'\nimport type { ToolsConfig, ToolsInput, ToolsResult, MCPServerConfig } from './types.js'\nimport { MCPClient } from './mcp-client.js'\n\nexport class ToolsMember extends BaseAgent {\n  private toolsConfig: ToolsConfig\n  private mcpServerConfig: MCPServerConfig | null = null\n\n  constructor(\n    config: AgentConfig,\n    private readonly env: Env\n  ) {\n    super(config)\n\n    const cfg = config.config as ToolsConfig | undefined\n    if (!cfg || !cfg.mcp || !cfg.tool) {\n      throw new Error('Tools agent requires \"mcp\" (server name) and \"tool\" (tool name) in config')\n    }\n\n    this.toolsConfig = {\n      mcp: cfg.mcp,\n      tool: cfg.tool,\n      timeout: cfg.timeout,\n      cacheDiscovery: cfg.cacheDiscovery ?? true,\n      cacheTTL: cfg.cacheTTL || 3600,\n    }\n  }\n\n  protected async run(context: AgentExecutionContext): Promise<ToolsResult> {\n    const input = context.input as ToolsInput\n    const startTime = Date.now()\n\n    try {\n      // Load MCP server configuration\n      const serverConfig = await this.loadMCPServerConfig()\n\n      // Create MCP client\n      const client = new MCPClient(serverConfig)\n\n      // Invoke tool\n      const response = await client.invokeTool(this.toolsConfig.tool, input)\n\n      return {\n        tool: this.toolsConfig.tool,\n        server: this.toolsConfig.mcp,\n        content: response.content,\n        duration: Date.now() - startTime,\n        isError: response.isError,\n      }\n    } catch (error) {\n      throw new Error(\n        `Failed to invoke tool \"${this.toolsConfig.tool}\" on MCP server \"${this.toolsConfig.mcp}\": ${\n          error instanceof Error ? error.message : 'Unknown error'\n        }`\n      )\n    }\n  }\n\n  /**\n   * Load MCP server configuration from conductor config\n   */\n  private async loadMCPServerConfig(): Promise<MCPServerConfig> {\n    // In a real implementation, this would load from conductor.config.ts\n    // For now, we'll check if it's available in env bindings\n    const mcpServers = (this.env as any).MCP_SERVERS as Record<string, MCPServerConfig> | undefined\n\n    if (!mcpServers) {\n      throw new Error(\n        'MCP servers not configured. Add MCP_SERVERS binding or configure in conductor.config.ts'\n      )\n    }\n\n    const serverConfig = mcpServers[this.toolsConfig.mcp]\n    if (!serverConfig) {\n      throw new Error(\n        `MCP server \"${this.toolsConfig.mcp}\" not found in configuration. Available servers: ${Object.keys(mcpServers).join(', ')}`\n      )\n    }\n\n    // Override timeout if specified in agent config\n    if (this.toolsConfig.timeout) {\n      serverConfig.timeout = this.toolsConfig.timeout\n    }\n\n    return serverConfig\n  }\n\n  /**\n   * Discover available tools from MCP server (for AI agent tool access)\n   */\n  async discoverTools(): Promise<any[]> {\n    const serverConfig = await this.loadMCPServerConfig()\n    const client = new MCPClient(serverConfig)\n\n    // Check cache if enabled\n    if (this.toolsConfig.cacheDiscovery) {\n      const cached = await this.getCachedTools(this.toolsConfig.mcp)\n      if (cached) {\n        return cached\n      }\n    }\n\n    // Fetch tools\n    const response = await client.listTools()\n\n    // Cache if enabled\n    if (this.toolsConfig.cacheDiscovery) {\n      await this.cacheTools(this.toolsConfig.mcp, response.tools)\n    }\n\n    return response.tools\n  }\n\n  /**\n   * Get cached tools from KV\n   */\n  private async getCachedTools(serverName: string): Promise<any[] | null> {\n    try {\n      const kv = (this.env as any).MCP_CACHE as KVNamespace | undefined\n      if (!kv) return null\n\n      const cacheKey = `mcp:tools:${serverName}`\n      const cached = await kv.get(cacheKey, 'json')\n      return cached as any[] | null\n    } catch (error) {\n      // Cache miss or error, return null\n      return null\n    }\n  }\n\n  /**\n   * Cache tools in KV\n   */\n  private async cacheTools(serverName: string, tools: any[]): Promise<void> {\n    try {\n      const kv = (this.env as any).MCP_CACHE as KVNamespace | undefined\n      if (!kv) return\n\n      const cacheKey = `mcp:tools:${serverName}`\n      await kv.put(cacheKey, JSON.stringify(tools), {\n        expirationTtl: this.toolsConfig.cacheTTL,\n      })\n    } catch (error) {\n      // Ignore cache errors\n    }\n  }\n}\n"],"names":[],"mappings":"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"}